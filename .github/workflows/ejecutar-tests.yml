name: Python Tests and Allure Report

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  run_tests:
    runs-on: ubuntu-latest

    steps:
    # -------------------------------
    - name: ‚¨áÔ∏è Checkout del C√≥digo
      uses: actions/checkout@v4

    # -------------------------------
    - name: üêç Configurar Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    # -------------------------------
    - name: ‚öôÔ∏è Configurar Node.js (Playwright)
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # -------------------------------
    - name: üì¶ Instalar Dependencias Python
      run: |
        pip install -r requirements.txt

    # -------------------------------
    - name: üîé Verificar Node y Playwright
      run: |
        node -v
        npm list -g playwright || echo "Playwright no est√° instalado globalmente."

    # -------------------------------
    - name: üåê Instalar Navegadores Playwright
      run: |
        python3.12 -m playwright install --with-deps

    # -------------------------------
    - name: üìù Crear archivo .env
      run: |
        echo "USERNAME=testing" >> .env
        echo "PASSWORD=testing" >> .env
        echo "Contenido generado:"
        cat .env

    # -------------------------------
    - name: ‚ñ∂Ô∏è Ejecutar Tests
      env:
        PLAYWRIGHT_HEADLESS: 1
      run: |
        python3.12 runner.py

    # -------------------------------
    #       INSTALAR ALLURE CLI
    # -------------------------------
    - name: üõ† Instalar Allure CLI
      run: |
        sudo apt update
        sudo apt install -y openjdk-11-jre
        wget https://github.com/allure-framework/allure2/releases/latest/download/allure-commandline.zip
        sudo apt install -y unzip
        unzip allure-commandline.zip
        sudo mv allure-*/ /opt/allure
        sudo ln -s /opt/allure/bin/allure /usr/bin/allure

    - name: üß™ Verificar instalaci√≥n de Allure
      run: |
        allure --version

    # -------------------------------
    #     MERGE + GENERAR REPORTE
    # -------------------------------
    - name: üß© Merge & Generate Allure Report
      run: |
        python3.12 merge_allure_and_generate.py

    # -------------------------------
    #     SUBIR ARTEFACTO A GITHUB
    # -------------------------------
    - name: üì§ Subir Reporte Allure
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: allure-report/
        retention-days: 7

    # -------------------------------
    - name: üéâ Finalizado
      run: echo "Tests ejecutados y reporte Allure publicado como artefacto."
